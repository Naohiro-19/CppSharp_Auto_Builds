name: Build and Release CppSharp Binaries

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        platform: [x86, x64]
        configuration: [Release]

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v6

      - name: Clone CppSharp Repository
        shell: bash
        run: |
          if [ ! -d "CppSharp" ]; then
            git clone --recursive https://github.com/mono/CppSharp.git CppSharp
          fi

      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      # LLVMのビルドには Python と CMake が必要です
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate and Build
        shell: bash
        run: |
          cd CppSharp/build
          
          # x86版でLLVMバイナリがない場合、ソースからビルドを試みる
          if [ "${{ matrix.platform }}" == "x86" ]; then
            echo "Detected x86 platform. Checking LLVM availability..."
            # generateを一度試して失敗（LLVM unavailable）を検知した場合にLLVMビルドを実行
            if ! sh build.sh generate -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}; then
              echo "LLVM pre-built package not found. Building LLVM from source (this may take a while)..."
              sh build.sh clone_llvm
              sh build.sh build_llvm -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
              # LLVMビルド後に再度プロジェクト生成
              sh build.sh generate -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
            fi
          else
            # x64は通常通り実行
            echo "Generating build files for ${{ matrix.platform }}..."
            sh build.sh generate -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
          fi
          
          echo "Compiling CppSharp source code..."
          sh build.sh -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}

      - name: Package Binaries
        shell: pwsh
        run: |
          $zipName = "CppSharp-Windows-${{ matrix.platform }}.zip"
          # 成果物パスを柔軟に検索
          $binPath = "CppSharp/bin/${{ matrix.configuration }}_${{ matrix.platform }}"
          if (-not (Test-Path $binPath)) {
              $binPath = Get-ChildItem -Recurse -Directory -Filter "${{ matrix.configuration }}*" | 
                         Where-Object { $_.FullName -match "${{ matrix.platform }}" } | 
                         Select-Object -First 1 -ExpandProperty FullName
          }
          
          if ($null -eq $binPath) { 
              Write-Error "Binary output directory not found."
              exit 1 
          }
          
          Write-Host "Packaging from: $binPath"
          Compress-Archive -Path "$binPath\*" -DestinationPath $zipName -Force

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Update README
        run: |
          echo -e "\n---" >> README.md
          echo "### CppSharp ビルド完了通知" >> README.md
          echo "- **Status**: 32/64bit版バイナリ生成成功" >> README.md
          echo "- **DateTime**: $(date +'%Y-%m-%d %H:%M:%S') (JST)" >> README.md
          echo "- **Commit**: ${{ github.sha }}" >> README.md
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "docs: 32/64bitビルド完了通知 [skip ci]" || echo "No changes"
          git push
