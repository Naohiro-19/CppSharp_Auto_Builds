name: Build and Release CppSharp Binaries

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        platform: [x86, x64]
        configuration: [Release]

    steps:
      # 1. あなたのリポジトリをチェックアウト
      - name: Checkout your repository
        uses: actions/checkout@v4

      # 2. 公式マニュアルに基づき、CppSharp本体をクローン
      # リポジトリが空の場合でも、ここで本体を取得します
      - name: Clone CppSharp Repository
        shell: bash
        run: |
          if [ ! -d "CppSharp" ]; then
            git clone --recursive https://github.com/mono/CppSharp.git CppSharp
          fi

      # 3. MSVC v142 セットアップ
      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      # 4. 生成とビルド (公式マニュアルのコマンドをCppSharpディレクトリ内で実行)
      - name: Generate and Build
        shell: bash
        run: |
          cd CppSharp/build
          
          echo "Current directory: $(pwd)"
          
          # 依存関係（LLVM等）のダウンロードとプロジェクト生成
          echo "Generating build files for ${{ matrix.platform }}..."
          sh build.sh generate -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
          
          # ビルドの実行
          echo "Compiling source code..."
          sh build.sh -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}

      # 5. パッケージ化
      - name: Package Binaries
        shell: pwsh
        run: |
          $zipName = "CppSharp-Windows-${{ matrix.platform }}.zip"
          # CppSharpの出力先(binフォルダ)をターゲットにします
          $binPath = "CppSharp/bin/${{ matrix.configuration }}_${{ matrix.platform }}"
          
          # フォルダが存在しない場合の予備サーチ
          if (-not (Test-Path $binPath)) {
              $binPath = Get-ChildItem -Recurse -Directory -Filter "Release" | Select-Object -First 1 -ExpandProperty FullName
          }
          
          Write-Host "Packaging from: $binPath"
          Compress-Archive -Path "$binPath\*" -DestinationPath $zipName -Force

      # 6. Release へのアップロード (タグ時のみ)
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Update README
        run: |
          echo -e "\n---" >> README.md
          echo "### CppSharp ビルド通知" >> README.md
          echo "- **Status**: ビルド完了" >> README.md
          echo "- **Date**: $(date)" >> README.md
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "docs: update build status [skip ci]" || echo "No changes"
          git push
