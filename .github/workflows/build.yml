name: Build and Release CppSharp Binaries

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        platform: [x86, x64]
        configuration: [Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 1. MSVC v142 セットアップ
      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      # 2. ディレクトリ構造の確認とビルド実行
      # buildフォルダが見つからない場合でも、リポジトリ全体を検索して実行します
      - name: Generate and Build
        shell: bash
        run: |
          echo "Checking directory structure..."
          ls -R | grep ":$" | head -n 20 # 構造をログに出力して確認
          
          # buildディレクトリを探す（リポジトリ直下にない場合を考慮）
          BUILD_DIR=$(find . -name "build.sh" -printf '%h\n' | head -n 1)
          
          if [ -z "$BUILD_DIR" ]; then
            echo "Error: build.sh not found in the repository."
            exit 1
          fi
          
          echo "Found build.sh in: $BUILD_DIR"
          cd "$BUILD_DIR"
          
          echo "Generating build files for ${{ matrix.platform }}..."
          sh build.sh generate -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
          
          echo "Compiling source code..."
          sh build.sh -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}

      # 3. パッケージ化
      - name: Package Binaries
        shell: pwsh
        run: |
          # ビルド成果物(dll/exe)を再帰的に探してzipにまとめます
          $zipName = "CppSharp-Windows-${{ matrix.platform }}.zip"
          mkdir dist_temp
          
          # Releaseビルドの成果物を収集
          Get-ChildItem -Recurse -Filter "CppSharp*.dll" | Copy-Item -Destination dist_temp/
          Get-ChildItem -Recurse -Filter "CppSharp*.exe" | Copy-Item -Destination dist_temp/
          
          if ((Get-ChildItem dist_temp).Count -eq 0) {
              Write-Error "No binaries found to package."
              exit 1
          }
          
          Compress-Archive -Path "dist_temp\*" -DestinationPath $zipName -Force
          Write-Host "Created $zipName"

      # 4. Release へのアップロード
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Update README
        run: |
          echo -e "\n---" >> README.md
          echo "### ビルド通知" >> README.md
          echo "- **ステータス**: 成功" >> README.md
          echo "- **プラットフォーム**: Windows ${{ matrix.platform }}" >> README.md
          echo "- **更新日**: $(date +'%Y-%m-%d %H:%M:%S')" >> README.md
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "docs: build notification [skip ci]" || echo "No changes"
          git push
