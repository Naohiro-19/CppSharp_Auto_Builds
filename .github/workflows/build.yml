name: Build and Release CppSharp Binaries (x64 Only)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # 手動実行ボタンも有効化

permissions:
  contents: write

jobs:
  build:
    name: Build (x64)
    runs-on: windows-2022

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v6

      - name: Clone CppSharp Repository
        shell: bash
        run: |
          if [ ! -d "CppSharp" ]; then
            git clone --recursive https://github.com/mono/CppSharp.git CppSharp
          fi

      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate and Build (x64)
        shell: bash
        run: |
          cd CppSharp/build
          
          echo "Generating build files for x64..."
          if ! sh build.sh generate -configuration Release -platform x64; then
            echo "Pre-built LLVM not found. Preparing LLVM from source..."
            sh build.sh clone_llvm
            sh build.sh generate -configuration Release -platform x64
          fi
          
          echo "Compiling CppSharp source code..."
          sh build.sh -configuration Release -platform x64

      - name: Package Binaries
        shell: pwsh
        run: |
          $zipName = "CppSharp-Windows-x64.zip"
          $binPath = "CppSharp/bin/Release_x64"
          
          if (-not (Test-Path $binPath)) {
              $binPath = Get-ChildItem -Recurse -Directory -Filter "Release*" | 
                         Where-Object { $_.FullName -match "x64" } | 
                         Select-Object -First 1 -ExpandProperty FullName
          }
          
          if ($null -eq $binPath) { 
              Write-Error "Binary output directory not found."
              exit 1 
          }
          
          Write-Host "Packaging from: $binPath"
          Compress-Archive -Path "$binPath\*" -DestinationPath $zipName -Force

      - name: Upload to Release (latest)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Automated Build
          body: |
            ## CppSharp x64 Build
            このリリースは自動ビルドによって生成されました。
            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            - **Commit**: ${{ github.sha }}
          draft: false
          prerelease: false
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Update README
        run: |
          echo -e "\n---" >> README.md
          echo "### CppSharp ビルド完了通知" >> README.md
          echo "- **Status**: x64版バイナリ生成成功（Releasesにアップロード済）" >> README.md
          echo "- **Latest Release**: [Download Here](${{ github.server_url }}/${{ github.repository }}/releases/tag/latest)" >> README.md
          echo "- **DateTime**: $(date +'%Y-%m-%d %H:%M:%S') (JST)" >> README.md
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "docs: x64ビルド完了・リリース更新 [skip ci]" || echo "No changes"
          git push
