name: Build and Release CppSharp Binaries (x64 Only)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (x64)
    runs-on: windows-2022

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v6

      - name: Clone CppSharp Repository
        shell: bash
        run: |
          if [ ! -d "CppSharp" ]; then
            git clone --recursive https://github.com/mono/CppSharp.git CppSharp
          fi

      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Generate and Build (x64)
        shell: bash
        run: |
          cd CppSharp/build
          # 確実にクリーンな状態で生成
          sh build.sh generate -configuration Release -platform x64
          
          echo "Compiling CppSharp source code..."
          # 実際のコンパイル実行
          sh build.sh -configuration Release -platform x64

      - name: Collect and Package Binaries
        shell: pwsh
        run: |
          $zipName = "CppSharp-Windows-x64-Full.zip"
          $staging = "publish_staging"
          New-Item -ItemType Directory -Path $staging -Force

          # 1. CppSharp のメインバイナリを収集 (Release_x64)
          # binフォルダ以下にある全.dll, .exe, .libをステージングへコピー
          Write-Host "Collecting binaries..."
          Get-ChildItem -Path "CppSharp/bin" -Recurse -Include *.dll, *.exe, *.lib, *.pdb | 
            Copy-Item -Destination $staging -Force

          # 2. LLVM/Clang 等の依存関係も漏らさず収集 (もし別フォルダにある場合)
          # build/lib フォルダなども探索対象に含める
          if (Test-Path "CppSharp/build/lib") {
              Get-ChildItem -Path "CppSharp/build/lib" -Recurse -Include *.dll | 
                Copy-Item -Destination $staging -Force
          }

          # 3. 容量チェック (1MB以下なら失敗とみなす)
          $totalSize = (Get-ChildItem $staging -Recurse | Measure-Object -Property Length -Sum).Sum
          Write-Host "Total package size: $($totalSize / 1KB) KB"
          if ($totalSize -lt 1MB) {
              Write-Error "Binary collection failed. Resulting package is too small ($($totalSize / 1KB) KB)."
              exit 1
          }

          # パッケージング
          Compress-Archive -Path "$staging\*" -DestinationPath $zipName -Force

      - name: Upload to Release (latest)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Automated Build
          body: |
            ## CppSharp x64 Build (Binary Package)
            このビルドには CppSharp の実行に必要なバイナリが含まれています。
            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            - **Commit**: ${{ github.sha }}
          draft: false
          prerelease: false
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Update README
        run: |
          echo -e "\n---" >> README.md
          echo "### CppSharp ビルド完了通知" >> README.md
          echo "- **Status**: x64版フルバイナリ生成成功" >> README.md
          echo "- **Download**: [CppSharp-Windows-x64-Full.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/latest/CppSharp-Windows-x64-Full.zip)" >> README.md
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "docs: x64ビルド完了・リンク更新 [skip ci]" || echo "No changes"
          git push
