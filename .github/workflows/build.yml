name: Build and Release CppSharp Binaries (x64 Only)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (x64)
    runs-on: windows-2022

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v6

      - name: Clone CppSharp Repository
        shell: bash
        run: |
          if [ ! -d "CppSharp" ]; then
            git clone --recursive https://github.com/mono/CppSharp.git CppSharp
          fi

      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate and Build (x64)
        shell: bash
        run: |
          cd CppSharp/build
          if ! sh build.sh generate -configuration Release -platform x64; then
            sh build.sh clone_llvm
            sh build.sh generate -configuration Release -platform x64
          fi
          sh build.sh -configuration Release -platform x64

      - name: Package Binaries
        id: package
        shell: pwsh
        run: |
          $zipName = "CppSharp-Windows-x64.zip"
          $binPath = "CppSharp/bin/Release_x64"
          
          if (-not (Test-Path $binPath)) {
              $binPath = Get-ChildItem -Recurse -Directory -Filter "Release*" | 
                         Where-Object { $_.FullName -match "x64" } | 
                         Select-Object -First 1 -ExpandProperty FullName
          }
          
          if ($null -eq $binPath) { exit 1 }
          
          # ZIPåœ§ç¸®ã—ã¦ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆGITHUB_WORKSPACEï¼‰ã«é…ç½®
          Compress-Archive -Path "$binPath\*" -DestinationPath "./$zipName" -Force
          echo "ZIP_PATH=./$zipName" >> $env:GITHUB_ENV

      # ã“ã“ãŒé‡è¦ï¼šãƒ“ãƒ«ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Release ãƒšãƒ¼ã‚¸ã«å…¬é–‹ç´ä»˜ã‘ã™ã‚‹
      - name: Upload to Release (latest)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: CppSharp x64 Stable Build
          body: |
            ### ðŸ›  Automated Build Details
            CppSharpã®æœ€æ–°ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒã‚¤ãƒŠãƒªï¼ˆx64ï¼‰ã§ã™ã€‚
            
            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            - **Commit**: ${{ github.sha }}
            
            ä¸‹æ¬„ã® **Assets** ã‹ã‚‰ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
          draft: false
          prerelease: false
          files: |
            CppSharp-Windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Update README
        run: |
          echo -e "\n---" >> README.md
          echo "### ðŸš€ CppSharp æœ€æ–°ãƒã‚¤ãƒŠãƒªå…¬é–‹ä¸­" >> README.md
          echo "- **Status**: ãƒ“ãƒ«ãƒ‰æˆåŠŸ & ãƒªãƒªãƒ¼ã‚¹æ›´æ–°å®Œäº†" >> README.md
          echo "- **Download**: [CppSharp-Windows-x64.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/latest/CppSharp-Windows-x64.zip)" >> README.md
          echo "- **Last Updated**: $(date +'%Y-%m-%d %H:%M:%S') (JST)" >> README.md
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "docs: Releaseãƒªãƒ³ã‚¯æ›´æ–° [skip ci]" || echo "No changes"
          git push
