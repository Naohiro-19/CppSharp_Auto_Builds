name: Build and Release CppSharp Binaries

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        platform: [x86, x64]
        configuration: [Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. MSVC v142 セットアップ
      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      # 2. ビルド実行
      # working-directory を相対パスではなく環境変数から絶対パスを組み立てる形式に変更
      # また、実行前にディレクトリの存在を確認します
      - name: Generate and Build
        shell: bash
        run: |
          # buildディレクトリへ移動
          cd build
          
          echo "Current directory: $(pwd)"
          echo "Generating build files for ${{ matrix.platform }}..."
          
          # 公式マニュアルに基づき sh でスクリプトを実行
          sh build.sh generate -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
          
          echo "Compiling source code..."
          sh build.sh -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}

      # 3. パッケージ化
      - name: Package Binaries
        shell: pwsh
        run: |
          # CppSharpのビルド成果物は通常 root/bin に出力されます
          $binDir = "bin/${{ matrix.configuration }}"
          $zipName = "CppSharp-Windows-${{ matrix.platform }}.zip"
          
          if (Test-Path $binDir) {
              Compress-Archive -Path "$binDir\*" -DestinationPath $zipName -Force
          } else {
              Write-Warning "Target directory $binDir not found. Checking alternate locations..."
              # 万が一場所が違う場合のために、生成されたdllを探してパッケージ化を試みます
              Get-ChildItem -Recurse -Filter "CppSharp*.dll"
              Compress-Archive -Path "bin\*" -DestinationPath $zipName -Force
          }

      # 4. Release へのアップロード (タグプッシュ時のみ)
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Update README in Japanese
        run: |
          # 日本語での通知を追記
          echo -e "\n---" >> README.md
          echo "### ビルド通知 (GitHub Actions)" >> README.md
          echo "- **ステータス**: 正常終了" >> README.md
          echo "- **プラットフォーム**: Windows x86 / x64" >> README.md
          echo "- **最終更新**: $(date +'%Y-%m-%d %H:%M:%S') (JST)" >> README.md
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "docs: ビルド完了通知を更新 [skip ci]" || echo "No changes"
          git push
