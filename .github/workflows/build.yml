name: Build and Release CppSharp Binaries

on:
  push:
    tags:
      - 'v*' # v1.0.0 のようなタグがプッシュされた時に起動

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: windows-2022
    strategy:
      matrix:
        # 32ビット(x86)と64ビット(x64)の両方をターゲットにする
        platform: [x86, x64]
        configuration: [Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. Visual Studio 2019 ビルドツール (v142) のセットアップ
      # 公式マニュアルに基づき、MSVC v142 をインストールします
      - name: Setup MSVC v142 Build Tools
        uses: microsoft/setup-msbuild@v2

      # 2. 依存関係の解決 (sh, curl, 7-Zip は Windows Runner に標準搭載)
      # Git for Windows の sh.exe を利用できるようにパスを確認
      - name: Add Shell to PATH
        run: echo "C:\Program Files\Git\bin" >> $GITHUB_PATH
        shell: bash

      # 3. ビルドファイルの生成 (Generate build files)
      # 公式マニュアルの build.sh generate を実行
      - name: Generate build files
        run: |
          cd build
          sh build.sh generate -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
        shell: cmd

      # 4. ソースコードのコンパイル
      # 公式マニュアルの build.sh (compile) を実行
      - name: Compile source code
        run: |
          cd build
          sh build.sh -configuration ${{ matrix.configuration }} -platform ${{ matrix.platform }}
        shell: cmd

      # 5. アーティファクトの準備
      # 配布用にビルド成果物をZIPにまとめます（出力先はCppSharpの構成に依存）
      - name: Prepare Package
        run: |
          mkdir dist
          xcopy bin\${{ matrix.configuration }}\* dist\ /E /Y
          7z a CppSharp-Windows-${{ matrix.platform }}.zip .\dist\*

      # 6. GitHub Release へのアップロード
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: CppSharp-Windows-${{ matrix.platform }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Update README with Japanese Notification
        run: |
          echo "## ビルド完了通知" > notification.txt
          echo "最新のバイナリ（x86/x64）が正常にビルドされ、Releaseページに掲載されました。" >> notification.txt
          echo "ビルド日時: $(date)" >> notification.txt
        # 注: READMEを直接書き換える場合は、ここで git commit/push の処理を追加可能です。
